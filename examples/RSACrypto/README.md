# Demo Instructions

This example shows who to create a Lambda that will do RSA-SHA256 signatures for an agent.

## Generate Keys

Below is the example commands for private and public keys generation on a Linux box:

```
$ openssl genrsa -out privkey.pem 2048
Generating RSA private key, 2048 bit long modulus
(...)
e is 65537 (0x10001)

$ openssl rsa -pubout <privkey.pem >pubkey.pem
writing RSA key
```

The public key is going to be stored in `private.pem` file, the public key - in `pubkey.pem`.

## Preparing the Sample Node.js Code

The sample Node.js code can be found [here](RSALambda.js). Copy and paste the full private key text between the lines `-----BEGIN RSA PRIVATE KEY-----` and `-----END RSA PRIVATE KEY-----`. Plese note that the line structure from the original `privkey.pem` file should be preserved, ei. you shouldn't join the lines, for example:

```
-----BEGIN RSA PRIVATE KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtjdR7z8l1/Z8oSOn/RNb
qKc9f5/zsL17CHZ/fBDsS6WMLTblm0H5Kh1SAE2nFL2cpw3VlHeKHu+fvebl79sz
7fmaXpB6gmzq3i7u6iQzaUSkn9nEklo/1voZhX8fwlPQ7st6X4y//PG69RoFHzR0
IV9EUfLdAI/CC9qEhjf5x8Zg1PXOx/WXlXYHvTmOibMhGF6MlV9PDLYrank2iASE
afzDVvc4RwT0JUTN1dRoOAB9js298E5Jggd8zDnpsmarrFj/rEksyBdhLl8PHRoy
GhsSFmIxNsEmbog00bcI3x1cW15b1VzuYMM2NzDEa9N12mN3Jkq2RNlg56qGTxEL
hwIDAQAB
-----END RSA PRIVATE KEY-----

// Rest of the lambda function
```

**NOTE**: As the sample code includes the private key verbatim in the source, it should be treated carefully, and not checked into version control!

## Setting up a Lambda

1. Go to the AWS Lambda console.
1. Select `Create a Lambda function`
1. Under the `Select blueprint` choose `Blank function`
1. Select `Configure function`:
    1. Give function a name `RSAsign`
    1. Select runtime `Node.js 4.3`
    1. Paste in code from above.
    1. Leave “Handler” as default (“index.handler”)
    1. Set “Role” to “Create new role from template(s)”
    1. Set “Role name” to “role_with_no_permissions”
    1. Leave “Policy templates” empty
    1. “Next”
1. “Create function”

## Setting up AIM Policy

1. Go to the AWS IAM console.
1. “Policies”
1. “Create Policy”
1. “Policy Generator”: “Select”
1. “Edit Permissions”:
    1. “Effect” = “Allow”
    1. “AWS Service” = “AWS Lambda”
    1. “Actions”: check “Invoke”
    1. “Amazon Resource Name (ARN)” paste in the ARN of the created Lambda
    1. “Next Step”
1. Give your policy a name, for example, “allow-calling-RSALambda”

## Setting up the AIM User

1. Go to the AWS IAM console.
1. “Users”
1. “Add user”
1. Choose a user name, I chose “agent-calling-lambda”
1. Check “Programmatic access” but not anything else
1. “Next: Permissions”
1. “Attach existing policies directly”
1. Check “allow-calling-RSALambda”
1. “Next: Review”
1. “Create user”
1. Copy down your “Access key ID” and “Secret access key"

## Setting up Agent Code

Here is some agent [code](agent.nut).

Set the example code configuration parameters with values retrieved on the previous steps:

Parameter             | Description
----------------------| -----------
AWS_LAMBDA_REGION     | AWS region (e.g. "us-east-1")
ACCESS_KEY_ID         | IAM Access Key ID
SECRET_ACCESS_KEY     | IAM Secret Access Key

Run the example code and it should print the signature generated by the Lambda function.

# License

The AWSLambda library is licensed under the [MIT License](../../LICENSE).

